% -------------------
% Normal Laboratory Test Ranges (Expanded)
% -------------------
% Format: normal_range(Test, Min, Max, AgeGroup, Gender, Unit).
% -------------------

normal_range(alanine_aminotransferase, 8, 78, infant, both, 'U/L').
normal_range(alanine_aminotransferase, 8, 36, adult, both, 'U/L').

normal_range(albumin, 2.0, 4.0, infant, both, 'g/dL').
normal_range(albumin, 3.5, 5.5, adult, both, 'g/dL').

normal_range(alkaline_phosphatase, 60, 130, infant, both, 'U/L').
normal_range(alkaline_phosphatase, 85, 400, toddler, both, 'U/L').
normal_range(alkaline_phosphatase, 85, 400, child, both, 'U/L').
normal_range(alkaline_phosphatase, 85, 400, teen, both, 'U/L').
normal_range(alkaline_phosphatase, 30, 115, adult, both, 'U/L').

normal_range(ammonia, 90, 150, infant, both, 'mcg/dL').
normal_range(ammonia, 40, 120, toddler, both, 'mcg/dL').
normal_range(ammonia, 40, 120, child, both, 'mcg/dL').
normal_range(ammonia, 40, 120, teen, both, 'mcg/dL').
normal_range(ammonia, 18, 54, adult, both, 'mcg/dL').

normal_range(aspartate_aminotransferase, 18, 74, infant, both, 'U/L').
normal_range(aspartate_aminotransferase, 15, 46, toddler, both, 'U/L').
normal_range(aspartate_aminotransferase, 15, 46, child, both, 'U/L').
normal_range(aspartate_aminotransferase, 15, 46, teen, both, 'U/L').
normal_range(aspartate_aminotransferase, 5, 35, adult, both, 'U/L').

normal_range(bicarbonate, 22, 29, adult, both, 'mEq/L').

normal_range(bilirubin_direct, 0, 1.5, infant, both, 'mg/dL').
normal_range(bilirubin_direct, 0, 0.5, adult, both, 'mg/dL').

normal_range(bilirubin_total, 2.0, 10.0, infant, both, 'mg/dL').
normal_range(bilirubin_total, 0, 1.5, adult, both, 'mg/dL').

normal_range(blood_pressure_diastolic, 60, 80, both, both, 'mmHg').
normal_range(blood_pressure_systolic, 90, 120, both, both, 'mmHg').

normal_range(calcium, 7.0, 12.0, infant, both, 'mg/dL').
normal_range(calcium, 8.8, 11.2, toddler, both, 'mg/dL').
normal_range(calcium, 8.8, 11.2, child, both, 'mg/dL').
normal_range(calcium, 8.8, 11.2, teen, both, 'mg/dL').
normal_range(calcium, 9.0, 11.0, adult, both, 'mg/dL').

normal_range(chloride, 96, 106, adult, both, 'mEq/L').

normal_range(cholesterol, 45, 170, infant, both, 'mg/dL').
normal_range(cholesterol, 65, 175, toddler, both, 'mg/dL').
normal_range(cholesterol, 65, 175, child, both, 'mg/dL').
normal_range(cholesterol, 65, 175, teen, both, 'mg/dL').
normal_range(cholesterol, 120, 230, adult, both, 'mg/dL').

normal_range(creatinine, 0, 0.6, infant, both, 'mg/dL').
normal_range(creatinine, 0.5, 1.5, adult, both, 'mg/dL').

normal_range(glucose, 30, 90, infant, both, 'mg/dL').
normal_range(glucose, 60, 105, toddler, both, 'mg/dL').
normal_range(glucose, 60, 105, child, both, 'mg/dL').
normal_range(glucose, 60, 105, teen, both, 'mg/dL').
normal_range(glucose, 70, 110, adult, both, 'mg/dL').

normal_range(hemoglobin, 13.5, 20.0, infant, both, 'g/dL').
normal_range(hemoglobin, 10.0, 14.0, child, both, 'g/dL').
normal_range(hemoglobin, 11.5, 15.5, teen, both, 'g/dL').
normal_range(hemoglobin, 13.5, 17.5, adult, male, 'g/dL').
normal_range(hemoglobin, 12.0, 15.5, adult, female, 'g/dL').

normal_range(hemoglobin_a1c, 4.0, 5.6, adult, both, '%').

normal_range(iron, 110, 270, infant, both, 'mcg/dL').
normal_range(iron, 60, 120, toddler, both, 'mcg/dL').
normal_range(iron, 55, 120, child, both, 'mcg/dL').
normal_range(iron, 55, 120, teen, both, 'mcg/dL').
normal_range(iron, 70, 180, adult, both, 'mcg/dL').

normal_range(lactic_acid, 2, 20, both, both, 'mg/dL').
normal_range(lipase, 20, 140, child, both, 'U/L').
normal_range(lipase, 0, 190, adult, both, 'U/L').

normal_range(magnesium, 1.5, 2.5, both, both, 'mEq/L').

normal_range(phosphorus, 4.2, 9.0, infant, both, 'mg/dL').
normal_range(phosphorus, 3.8, 6.7, toddler, both, 'mg/dL').
normal_range(phosphorus, 3.8, 6.7, child, both, 'mg/dL').
normal_range(phosphorus, 3.8, 6.7, teen, both, 'mg/dL').
normal_range(phosphorus, 2.5, 5.0, adult, both, 'mg/dL').

normal_range(potassium, 4.5, 7.2, infant, both, 'mEq/L').
normal_range(potassium, 3.5, 5.0, toddler, both, 'mEq/L').
normal_range(potassium, 3.5, 5.0, child, both, 'mEq/L').
normal_range(potassium, 3.5, 5.0, teen, both, 'mEq/L').
normal_range(potassium, 3.5, 5.0, adult, both, 'mEq/L').

normal_range(sodium, 136, 145, both, both, 'mEq/L').

normal_range(thyroid_stimulating_hormone, 0.7, 6.4, child, both, 'mIU/L').
normal_range(thyroid_stimulating_hormone, 0.4, 4.0, adult, both, 'mIU/L').

normal_range(triglycerides, 0, 171, infant, both, 'mg/dL').
normal_range(triglycerides, 20, 130, child, both, 'mg/dL').
normal_range(triglycerides, 20, 130, teen, both, 'mg/dL').
normal_range(triglycerides, 40, 160, adult, male, 'mg/dL').
normal_range(triglycerides, 35, 135, adult, female, 'mg/dL').

normal_range(white_blood_cell_count, 5.0, 17.5, child, both, '10^9/L').
normal_range(white_blood_cell_count, 4.5, 13.5, teen, both, '10^9/L').
normal_range(white_blood_cell_count, 4.5, 11.0, adult, both, '10^9/L').

% -------------------
% Age Group Classification
% -------------------
age_group(Age, infant) :- Age > 0, Age =< 1.
age_group(Age, toddler) :- Age > 1, Age =< 4.
age_group(Age, child) :- Age > 4, Age < 13.
age_group(Age, teen) :- Age >= 13, Age < 18.
age_group(Age, adult) :- Age >= 18.

% -------------------
% Abnormal Value Detection
% -------------------
abnormal(Person, TestRaw, Value, Status, Unit) :-
    normalize_test_name(TestRaw, Test),
    patient(Person, Age, Gender),
    age_group(Age, AgeGroup),
    find_normal_range_with_fallback(Test, AgeGroup, Gender, Min, Max, Unit),
    (Value < Min -> Status = low ;
     Value > Max -> Status = high ;
     Status = normal).

% -------------------
% Range Fallbacks
% -------------------
find_normal_range_with_fallback(Test, AgeGroup, Gender, Min, Max, Unit) :-
    (   normal_range(Test, Min, Max, AgeGroup, Gender, Unit)
    ;   normal_range(Test, Min, Max, AgeGroup, both, Unit)
    ;   normal_range(Test, Min, Max, _, Gender, Unit)
    ;   normal_range(Test, Min, Max, _, both, Unit)
    ),
    !.

% -------------------
% Normalizing Test Names
% -------------------
normalize_test_name(Raw, Cleaned) :-
    (   atom(Raw) -> AtomRaw = Raw ; atom_string(Raw, AtomRaw)
    ),
    downcase_atom(AtomRaw, Lower),
    atom_chars(Lower, Chars),
    maplist(replace_non_alnum, Chars, NormalizedChars),
    atom_chars(Cleaned, NormalizedChars).

replace_non_alnum(Char, '_') :- \+ char_type(Char, alnum), !.
replace_non_alnum(Char, Char).

% -------------------
% Diagnoses
% -------------------
diagnosis(Person, diabetes) :-
    lab_test(Person, fasting_glucose, Glucose),
    Glucose >= 126.

diagnosis(Person, prediabetes) :-
    lab_test(Person, fasting_glucose, Glucose),
    Glucose >= 100, Glucose =< 125.

diagnosis(Person, anemia) :-
    patient(Person, _, male),
    lab_test(Person, hemoglobin, Hgb),
    Hgb < 14.

diagnosis(Person, anemia) :-
    patient(Person, _, female),
    lab_test(Person, hemoglobin, Hgb),
    Hgb < 12.

diagnosis(Person, hyperlipidemia) :-
    lab_test(Person, ldl_cholesterol, LDL),
    LDL > 100.

diagnosis(Person, kidney_disease) :-
    lab_test(Person, creatinine, Creat),
    Creat > 1.3.

diagnosis(Person, liver_disease) :-
    lab_test(Person, alt, ALT),
    lab_test(Person, ast, AST),
    ALT > 40, AST > 35.

diagnosis(Person, hyperkalemia) :-
    lab_test(Person, potassium, K),
    K > 5.5.

diagnosis(Person, hyponatremia) :-
    lab_test(Person, sodium, Na),
    Na < 135.

% -------------------
% Find All Diagnoses
% -------------------
all_diagnoses(Person, Diagnoses) :-
    findall(D, diagnosis(Person, D), Diagnoses).

% -------------------
% Explanation Generator
% -------------------
diagnosis_explanation(Person, Diagnosis, Explanation) :-
    diagnosis(Person, Diagnosis),
    format(atom(Explanation), '~w may have ~w based on current lab values.', [Person, Diagnosis]).

all_explanations(Person, Explanations) :-
    findall(Explanation, diagnosis_explanation(Person, _, Explanation), Explanations).

% -------------------
% Sample Data
% -------------------
patient(john, 35, male).
patient(sarah, 10, female).
patient(baby_jane, 1, female).

lab_test(john, fasting_glucose, 130).
lab_test(john, hemoglobin, 13).
lab_test(john, potassium, 6.0).

lab_test(sarah, fasting_glucose, 110).
lab_test(sarah, hemoglobin, 11).
lab_test(sarah, sodium, 130).

lab_test(baby_jane, bilirubin_total, 8.0).
lab_test(baby_jane, potassium, 5.0).
lab_test(baby_jane, fasting_glucose, 200).
lab_test(baby_jane, alt, 45).
lab_test(baby_jane, ast, 40).
